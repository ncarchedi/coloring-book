## Codebase Patterns

- **OpenAI image edit API**: Use `openai.images.edit()` with the `image` parameter (as `Uploadable`) to pass reference images to gpt-image-1. Use `toFile()` from the openai SDK to convert a Buffer to an Uploadable. This preserves composition better than text-only prompts.
- **Base64 to Uploadable**: `const buf = Buffer.from(base64Data, "base64"); const file = await toFile(buf, "photo.jpg", { type: "image/jpeg" });`

---

## 2026-01-31 - US-010
- Switched from `openai.images.generate()` to `openai.images.edit()` to pass the original uploaded photo as a reference image to gpt-image-1
- GPT-4o vision description is kept as supplementary context in the prompt
- Updated prompt to emphasize preserving composition, poses, and key details from the original photo
- Files changed: `src/app/api/generate/route.ts`
- **Learnings for future iterations:**
  - The OpenAI `images.edit` endpoint accepts an `image` parameter (Uploadable or array) for reference images with gpt-image-1
  - Use `toFile()` from the `openai` package to convert a Buffer into an Uploadable
  - The `images.edit` endpoint supports the same `quality` and `size` params as `images.generate`
  - Cannot verify actual generation output without a real API key; verified build, lint, and UI flow pass
---

## 2026-01-31 - US-012
- Removed extra `pt-6` from CardContent in age-selector component; Card already provides `py-6` so the additional top padding was redundant
- Files changed: `src/components/age-selector.tsx`
- **Learnings for future iterations:**
  - shadcn Card (v4) has `py-6` built in, and CardContent has `px-6` — don't add `pt-6` to CardContent or you get double top padding
---

## 2026-01-31 - US-011
- Fixed remove-image button positioning: moved Button outside CardContent to be a direct child of Card with `relative overflow-hidden py-0`
- Removed padding from CardContent (`p-0`) so the image fills the card edge-to-edge
- Button now sits flush at top-right corner of the preview card
- Files changed: `src/components/photo-upload.tsx`
- **Learnings for future iterations:**
  - shadcn Card has `py-6` and CardContent has `px-6` by default — override with `py-0` and `p-0` when you need edge-to-edge content
  - For absolute-positioned elements in cards, position them on the Card itself (with `relative`), not inside CardContent
---

## 2026-02-01 - US-016
- Implemented theme-based coloring book generation flow
- Created new API route `POST /api/generate-theme` that uses GPT-4o to brainstorm unique scene descriptions, then generates each page via gpt-image-1
- Replaced placeholder "coming soon" page with full UI: theme textarea, age selector, page count slider (2-10), generate button
- Added shadcn Textarea component (installed via `npx shadcn add textarea`)
- Results display in a grid with selection, individual PNG download, and PDF export
- Loading state shows skeleton placeholders for all pages being generated
- Error handling for individual page failures (others continue)
- Files changed: `src/app/create/theme/page.tsx`, `src/app/api/generate-theme/route.ts`, `src/components/ui/textarea.tsx`
- **Learnings for future iterations:**
  - Theme-based generation uses `images.generate` (not `images.edit`) since there's no reference image
  - GPT-4o scene planning step with `temperature: 1` gives good variety in scene descriptions
  - Sequential image generation for multiple pages takes a long time — future story US-017 should add streaming/progressive display
  - Parsing GPT-4o JSON output needs a regex fallback for markdown code blocks
---

## 2026-02-01 - US-017
- Split monolithic `/api/generate-theme` into two endpoints: `/api/generate-theme/plan` (scene planning) and `/api/generate-theme/page` (single page generation)
- Updated theme page to call endpoints sequentially: plan scenes first, then generate each page one by one
- Pages appear in the grid as soon as each completes — skeleton placeholders for pending pages
- Progress indicator: button shows "Generating page X of Y", counter shows "N of M pages generated"
- Added progress bar (animated) showing completion percentage
- Per-page status labels: "generating…" for active page, "waiting" for queued pages
- Per-page error handling: failed pages show error message, others continue generating
- Files changed: `src/app/create/theme/page.tsx`, `src/app/api/generate-theme/plan/route.ts` (new), `src/app/api/generate-theme/page/route.ts` (new)
- **Learnings for future iterations:**
  - Splitting batch API calls into plan + sequential single-item calls enables progressive UI updates
  - The original batch endpoint (`/api/generate-theme/route.ts`) is kept for backwards compatibility but the UI no longer uses it
  - `useRef` for abort flags avoids stale closure issues in async loops
---

## 2026-02-01 - US-018
- Created `MultiPhotoUpload` component supporting multi-file drag-and-drop, thumbnail grid, remove individual photos, and reorder (move up/down)
- Rewrote `/create/photos` page to use batch photo upload instead of single-photo upload
- Sequential generation: calls existing `/api/generate` endpoint once per uploaded photo
- Progress bar and "Converting photo X of Y" indicator during generation
- Side-by-side original/coloring-page display in results grid
- Per-photo error handling: if one fails, others continue
- All photos held in browser memory only
- Files changed: `src/components/multi-photo-upload.tsx` (new), `src/app/create/photos/page.tsx` (rewritten)
- **Learnings for future iterations:**
  - The existing `/api/generate` endpoint works unchanged for batch — just call it once per photo sequentially
  - Multi-file input needs `multiple` attribute and clearing `inputRef.current.value = ""` after each selection to allow re-selecting
  - Reorder buttons use opacity-0 group-hover:opacity-100 for clean hover reveal
---

## 2026-02-01 - US-019
- All acceptance criteria were already implemented in US-018 (batch photo upload flow)
- Verified in browser: progress indicator ("Converting photo X of Y"), progressive grid rendering, side-by-side original/coloring layout, skeleton placeholders, per-page error handling
- No code changes needed — marked as passing
- Files changed: none (prd.json updated only)
- **Learnings for future iterations:**
  - US-018 scope overlapped significantly with US-019 — the batch upload story already included progress display and results grid
  - When stories have overlapping scope, verify acceptance criteria are met before writing new code
---
