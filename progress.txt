## Codebase Patterns

- **OpenAI image edit API**: Use `openai.images.edit()` with the `image` parameter (as `Uploadable`) to pass reference images to gpt-image-1. Use `toFile()` from the openai SDK to convert a Buffer to an Uploadable. This preserves composition better than text-only prompts.
- **Base64 to Uploadable**: `const buf = Buffer.from(base64Data, "base64"); const file = await toFile(buf, "photo.jpg", { type: "image/jpeg" });`

---

## 2026-01-31 - US-010
- Switched from `openai.images.generate()` to `openai.images.edit()` to pass the original uploaded photo as a reference image to gpt-image-1
- GPT-4o vision description is kept as supplementary context in the prompt
- Updated prompt to emphasize preserving composition, poses, and key details from the original photo
- Files changed: `src/app/api/generate/route.ts`
- **Learnings for future iterations:**
  - The OpenAI `images.edit` endpoint accepts an `image` parameter (Uploadable or array) for reference images with gpt-image-1
  - Use `toFile()` from the `openai` package to convert a Buffer into an Uploadable
  - The `images.edit` endpoint supports the same `quality` and `size` params as `images.generate`
  - Cannot verify actual generation output without a real API key; verified build, lint, and UI flow pass
---

## 2026-01-31 - US-012
- Removed extra `pt-6` from CardContent in age-selector component; Card already provides `py-6` so the additional top padding was redundant
- Files changed: `src/components/age-selector.tsx`
- **Learnings for future iterations:**
  - shadcn Card (v4) has `py-6` built in, and CardContent has `px-6` — don't add `pt-6` to CardContent or you get double top padding
---

## 2026-01-31 - US-011
- Fixed remove-image button positioning: moved Button outside CardContent to be a direct child of Card with `relative overflow-hidden py-0`
- Removed padding from CardContent (`p-0`) so the image fills the card edge-to-edge
- Button now sits flush at top-right corner of the preview card
- Files changed: `src/components/photo-upload.tsx`
- **Learnings for future iterations:**
  - shadcn Card has `py-6` and CardContent has `px-6` by default — override with `py-0` and `p-0` when you need edge-to-edge content
  - For absolute-positioned elements in cards, position them on the Card itself (with `relative`), not inside CardContent
---

## 2026-02-01 - US-016
- Implemented theme-based coloring book generation flow
- Created new API route `POST /api/generate-theme` that uses GPT-4o to brainstorm unique scene descriptions, then generates each page via gpt-image-1
- Replaced placeholder "coming soon" page with full UI: theme textarea, age selector, page count slider (2-10), generate button
- Added shadcn Textarea component (installed via `npx shadcn add textarea`)
- Results display in a grid with selection, individual PNG download, and PDF export
- Loading state shows skeleton placeholders for all pages being generated
- Error handling for individual page failures (others continue)
- Files changed: `src/app/create/theme/page.tsx`, `src/app/api/generate-theme/route.ts`, `src/components/ui/textarea.tsx`
- **Learnings for future iterations:**
  - Theme-based generation uses `images.generate` (not `images.edit`) since there's no reference image
  - GPT-4o scene planning step with `temperature: 1` gives good variety in scene descriptions
  - Sequential image generation for multiple pages takes a long time — future story US-017 should add streaming/progressive display
  - Parsing GPT-4o JSON output needs a regex fallback for markdown code blocks
---
